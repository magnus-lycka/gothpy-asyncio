<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>GothPy: Coroutines with async and await</title><meta charset="UTF-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="gothpy-asyncio.css" media="screen,projection"></link><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        showProcessingMessages: false,
        messageStyle: "none",
        TeX : { extensions : ['color.js'] }
      });
    </script></head><body class="impress-not-supported"><div id="impress" data-transition-duration="500"><div class="step step-level-1" step="0" data-scale="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-x="0" data-y="0" data-z="0"><h1 id="coroutines-with-async-and-await">Coroutines with async and await</h1><h2 id="sweat-your-cpus"><em>Sweat your CPUs!</em></h2><h2 id="gothpy-2017-08-23">GothPy 2017-08-23</h2><h2 id="magnus-lycka"><a href="https://github.com/magnus-lycka">Magnus</a> <a href="https://www.linkedin.com/in/lycka/">Lyck&#xE5;</a></h2></div><div class="step step-level-1" step="1" data-scale="0.16666666666666666" data-x="-666" data-y="-416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="irq"><strong>IRQ</strong></h1></div><div class="step step-level-1" step="2" data-scale="0.16666666666666666" data-x="-399" data-y="-416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="gocd-notifications-weren-t-enough">GoCD notifications weren't enough...</h1><div align="center">
<img src="gocd_notifications.png" width="735" height="177" />
</div><ul><li>Email the whole team about broken and fixed builds.</li><li>Notify on all pipelines in a group.</li><li>If X is in our group, we also need alerts on X-release-x.y.z in the release group.</li><li>Notified in slack instead?</li></ul></div><div class="step step-level-1" step="3" data-scale="0.16666666666666666" data-x="-133" data-y="-416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="180" data-z="0"><h1 id="jag-fick-en-liten-ide">Jag fick en liten id&#xE9;...</h1><div align="center">
<iframe width="853" height="480" src="https://www.youtube.com/embed/2cMbmG8t8vY?rel=0&amp;controls=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
</div></div><div class="step step-level-1" step="4" data-scale="0.16666666666666666" data-x="133" data-y="-416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="idea">Idea...</h1><ul><li>Mail all alerts in GoCD to a special address.</li><li>Intercept all mail from GoCD in special proxy.</li><li>Apply special rules on mails to the special address, pass other mail to the "real" mail server.</li><li>This led to writing <a href="https://github.com/magnus-lycka/mail2alert">mail2alert</a></li></ul><div align="center">
<img src="https://raw.githubusercontent.com/magnus-lycka/mail2alert/master/static/mail2alert_logo.png" />
</div></div><div class="step step-level-1" step="5" data-scale="0.16666666666666666" data-x="399" data-y="-416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="standard-library-smtpd">Standard library smtpd</h1><h2 id="this-module-offers-several-classes-to-implement-smtp-email-servers">This module offers several classes to implement SMTP (email) servers.</h2><p><em>The aiosmtpd package is a recommended replacement for this module. It is based on asyncio and provides a more straightforward API. smtpd should be considered deprecated.</em></p><h2 id="asyncio">Asyncio???</h2></div><div class="step step-level-1" step="6" data-scale="0.16666666666666666" data-x="666" data-y="-416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="mail2alert-simplified-sequence-diagram">mail2alert - simplified sequence diagram</h1><pre class="highlight ">+--------+   +----------+   +--------+   +-----------+
|Notifyer|   |Mail2alert|   |REST API|   |Mail Server|
+---+----+   +----+-----+   +----+---+   +------+----+
    |             |              |              |
   +++ SEND      +++             |              |
   | +----------&gt;| | GET        +++             |
   | |           | +-----------&gt;| |             |
   | |           | |  200 {...} | |
   | |           | |&lt;-----------+ |             |
   | |           | |            +-+             |
   | |           | | SEND                      +++
   | |           | |--------------------------&gt;| |
   | |           | |                       ACK | + - - -
   | |       ACK | |&lt;--------------------------| |
   | |&lt;----------+ |                           +-+
   +-+           +-+</pre></div><div class="step step-level-1" step="7" data-scale="0.16666666666666666" data-x="-666" data-y="-250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="concurrent-execution-of-multiple-tasks">Concurrent execution of multiple tasks</h1><ul><li>Preemptive multitasking (OS scheduler)<ul><li>Multiprocessing: Protected but heavy...</li><li>Multithreading: Faster but hard to debug and still some overhead...</li></ul></li><li>Cooperative Multitasking (event loop)<ul><li>Callbacks: Code flows backwards? (<a href="https://hackedbellini.org/development/writing-asynchronous-python-code-with-twisted-using-inlinecallbacks/">Example</a>)</li><li>Coroutines: ???</li></ul></li></ul></div><div class="step step-level-1" step="8" data-scale="0.16666666666666666" data-x="-399" data-y="-250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="coroutine-benefits-compared-with">Coroutine benefits compared with...</h1><dl><dt>Processes</dt><dd><p>Much less overhead. Always switch context at optimal time.</p></dd><dt>Threads</dt><dd><p>Less overhead. Easier to debug. Always switch context at optimal time.</p></dd><dt>Callbacks</dt><dd><p>Source code easier to read. Flows like non-concurrent code.</p></dd></dl><h2 id="but-it-can-only-utilize-one-cpu-core"><em>But it can only utilize one CPU core!</em></h2></div><div class="step step-level-1" step="9" data-scale="0.16666666666666666" data-x="-133" data-y="-250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="functions-generators-coroutines">Functions, Generators, Coroutines</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">my_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">my_generator</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span>


<span class="n">async</span> <span class="k">def</span> <span class="nf">my_coroutine</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span></pre></div><div class="step step-level-1" step="10" data-scale="0.16666666666666666" data-x="133" data-y="-250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="python-function">Python Function</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">my_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">my_function</span> <span class="n">at</span> <span class="mh">0x7f2e4b07eea0</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_function</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="mi">4</span>
<span class="o">&gt;&gt;&gt;</span></pre></div><div class="step step-level-1" step="11" data-scale="0.16666666666666666" data-x="399" data-y="-250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="python-generator">Python Generator</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">my_generator</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">yield</span> <span class="n">i</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_generator</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">my_generator</span> <span class="n">at</span> <span class="mh">0x7f2e49a09840</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">my_generator</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">my_generator</span> <span class="n">at</span> <span class="mh">0x7f2e460bf2b0</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="mi">0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">"&lt;stdin&gt;"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">StopIteration</span>
<span class="o">&gt;&gt;&gt;</span></pre></div><div class="step step-level-1" step="12" data-scale="0.16666666666666666" data-x="666" data-y="-250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="python-3-5-coroutine">Python 3.5+ coroutine</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">asyncio</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">async</span> <span class="k">def</span> <span class="nf">my_coroutine</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">t0</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">t1</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_coroutine</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">my_coroutine</span> <span class="n">at</span> <span class="mh">0x7f2e49a09840</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">my_coroutine</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span>
<span class="o">&lt;</span><span class="n">coroutine</span> <span class="nb">object</span> <span class="n">my_coroutine</span> <span class="n">at</span> <span class="mh">0x7f2e460bf2b0</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="mf">94327.881889242</span> <span class="mf">94330.884326</span>
<span class="o">&gt;&gt;&gt;</span></pre></div><div class="step step-level-1" step="13" data-scale="0.16666666666666666" data-x="-666" data-y="-83" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="python-3-4-coroutine">Python 3.4 coroutine</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">asyncio</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nd">@asyncio.coroutine</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">my_coroutine</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="o">...</span>     <span class="n">t0</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">t1</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">my_coroutine</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">my_coroutine</span> <span class="n">at</span> <span class="mh">0x7f2e459519d8</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">my_coroutine</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">c</span>
<span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">my_coroutine</span> <span class="n">at</span> <span class="mh">0x7f2e460bf3b8</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="mf">95398.736966465</span> <span class="mf">95402.738235799</span>
<span class="o">&gt;&gt;&gt;</span></pre><p><em>Don't use this!</em></p></div><div class="step step-level-1" step="14" data-scale="0.16666666666666666" data-x="666" data-y="-83" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="timeline">Timeline</h1><ul><li>Python 2.x std lib: asyncore &amp; asynchat</li><li>Python 2.x 3rd party: Greenlets, Twisted, gevent etc</li><li>Python 3.4: asyncio (provisional), @asyncio.coroutine</li><li>Python 3.5: async &amp; await syntax (Borrowed from C# / VB.NET)</li><li>Python 3.6: asyncio extended &amp; stable. Async generators &amp; comprehensions.</li><li>Python 3.7: ??? (Simplifications and better docs?) <a href="https://www.youtube.com/watch?v=2ZFFv-wZ8_g">https://www.youtube.com/watch?v=2ZFFv-wZ8_g</a></li></ul></div><div class="step step-level-1" step="15" data-scale="0.16666666666666666" data-x="-666" data-y="83" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="asyncio-concepts">Asyncio concepts</h1><ul><li>Event loops</li><li>Transports</li><li>Protocols</li><li>Futures, Tasks &amp; Coroutines</li><li>Async generators &amp; comprehensions</li><li>Synchronization primitives</li><li>Threadpool interface</li></ul></div><div class="step step-level-1" step="16" data-scale="0.015151515151515152" data-x="-688" data-y="53" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="event-loops">Event Loops</h1><blockquote><ul><li>The central execution device</li></ul><blockquote><ul><li>Register, execute &amp; cancel delayed calls</li><li>Create client and server transports</li><li>Launch subprocesses</li><li>Delegate costly function calls to threadpools</li></ul></blockquote><ul><li>Several implementations</li></ul><blockquote><ul><li>SelectorEventLoop - Default, limited to sockets in Windows</li><li>ProactorEventLoop - Only Windows, IOCP</li><li><a href="https://github.com/MagicStack/uvloop">uvloop</a> - 3rd party, based on <a href="https://github.com/libuv/libuv">libuv</a></li><li><a href="https://pypi.python.org/pypi/tokio">tokio</a> - 3rd party, based on Rust event loop <a href="https://tokio.rs/">tokio-rs</a>.</li></ul></blockquote></blockquote></div><div class="step step-level-1" step="17" data-scale="0.015151515151515152" data-x="-644" data-y="53" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="event-loop-objects">Event Loop objects</h1><pre class="highlight code python"><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="n">coroutine</span> <span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span> <span class="n">coroutine</span> <span class="ow">or</span> <span class="n">task</span> <span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>

<span class="n">loop</span><span class="o">.</span><span class="n">call_</span><span class="o">*</span><span class="p">(</span> <span class="n">function</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="o">...</span></pre></div><div class="step step-level-1" step="18" data-scale="0.015151515151515152" data-x="-600" data-y="53" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="event-loop-hello-world">Event Loop Hello World</h1><pre class="highlight code python"><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Hello World'</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="c1"># Schedule a call to hello_world()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>

<span class="c1"># Blocking call interrupted by loop.stop()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div><div class="step step-level-1" step="19" data-scale="0.015151515151515152" data-x="-555" data-y="53" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="id1">uvloop</h1><div align="center">
<img src="uvloop_performance.png" width="1053" height="385" />
</div><p><a href="https://github.com/MagicStack/uvloop">https://github.com/MagicStack/uvloop</a></p></div><div class="step step-level-1" step="20" data-scale="0.015151515151515152" data-x="-688" data-y="68" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="transports-protocols">Transports &amp; Protocols</h1><p>Borrowed from Twisted</p><dl><dt>Transports</dt><dd><p>E.g. TCP, UDP, Pipes</p></dd><dt>Protocols</dt><dd><p>E.g. HTTP, echo</p></dd></dl><p>You're likely to stick to standard transports, but to subclass asyncio.Protocol unless you just use HTTP etc.
There are <a href="https://docs.python.org/3/library/asyncio-protocol.html#protocol-examples">examples</a> in the docs.</p></div><div class="step step-level-1" step="21" data-scale="0.015151515151515152" data-x="-688" data-y="83" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="futures">Futures</h1><ul><li>Encapsulates the asynchronous execution of a callable.</li><li>Almost compatible with concurrent.futures.Future.</li><li>Methods: .cancel(), .cancelled(), .set_result(), .result(), .done()</li></ul><pre class="highlight code python"><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">slow_operation</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="s1">'Future is done!'</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">slow_operation</span><span class="p">(</span><span class="n">future</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div><div class="step step-level-1" step="22" data-scale="0.015151515151515152" data-x="-644" data-y="83" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="tasks">Tasks</h1><p>"Subclass of Future. Wrapper around coroutine to schedule it for execution.</p><p>A task is responsible for executing a coroutine object in an event loop.</p><p>If the wrapped coroutine yields from a future, the task suspends the execution
of the wrapped coroutine and waits for the completion of the future.</p><p>When the future is done, the execution of the wrapped coroutine restarts with
the result or the exception of the future."</p></div><div class="step step-level-1" step="23" data-scale="0.015151515151515152" data-x="-600" data-y="83" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="handle">Handle</h1><dl><dt>class asyncio.Handle</dt><dd><p>A callback wrapper object returned by loop.call_soon(), loop.call_soon_threadsafe(), loop.call_later(), and loop.call_at().</p></dd><dt>cancel()</dt><dd><p>Cancel the call. If the callback is already canceled or executed, this method has no effect.</p></dd></dl></div><div class="step step-level-1" step="24" data-scale="0.00505050505050505" data-x="-600" data-y="88" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="id2">Event Loop Hello World</h1><pre class="highlight code python"><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Hello World'</span><span class="p">)</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

<span class="c1"># Schedule a call to hello_world()</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>

<span class="c1"># we could...</span>
<span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

<span class="c1"># Blocking call interrupted by loop.stop()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div><div class="step step-level-1" step="25" data-scale="0.015151515151515152" data-x="-644" data-y="98" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="async-generators-and-comprehension">Async generators and comprehension</h1><pre class="highlight code python"><span class="n">async</span> <span class="k">def</span> <span class="nf">ticker</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">to</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>


<span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="n">async</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">aiter</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span>


<span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">await</span> <span class="n">fun</span><span class="p">()</span> <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="n">funcs</span> <span class="k">if</span> <span class="n">await</span> <span class="n">condition</span><span class="p">()]</span></pre></div><div class="step step-level-1" step="26" data-scale="0.015151515151515152" data-x="-600" data-y="98" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="async-for">Async for???</h1><pre class="highlight code python"><span class="n">async</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="p">():</span>
    <span class="o">....</span></pre><p>VS</p><pre class="highlight code python"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">await</span> <span class="n">f</span><span class="p">():</span>
    <span class="o">....</span></pre></div><div class="step step-level-1" step="27" data-scale="0.015151515151515152" data-x="-644" data-y="113" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="synchronization-primitives">Synchronization primitives</h1><dl><dt>Locks</dt><dd><ul><li>Lock</li><li>Event</li><li>Condition</li></ul></dd><dt>Semaphores</dt><dd><ul><li>Semaphore</li><li>BoundedSemaphore</li></ul></dd></dl><p>Very similar to those in the threading module,
but since there is no preemptive scheduling,
they aren't needed so often.</p></div><div class="step step-level-1" step="28" data-scale="0.015151515151515152" data-x="-644" data-y="128" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="threadpool-interface">Threadpool interface</h1><p>If you can't avoid blocking I/O, you can hand over work to
a concurrent.futures.ThreadPoolExecutor or
a concurrent.futures.ProcessPoolExecutor.</p><pre class="highlight code python"><span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></pre></div><div class="step step-level-1" step="29" data-scale="0.16666666666666666" data-x="666" data-y="83" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="asynchronous-context-managers">Asynchronous Context Managers</h1><p>A context manager which is able to suspend execution in its enter and exit methods.</p><pre class="highlight code python"><span class="k">class</span> <span class="nc">AsyncContextManager</span><span class="p">:</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">await</span> <span class="n">log</span><span class="p">(</span><span class="s1">'entering context'</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="n">await</span> <span class="n">log</span><span class="p">(</span><span class="s1">'exiting context'</span><span class="p">)</span></pre><p>...</p><pre class="highlight code python"><span class="n">async</span> <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="n">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
        <span class="o">...</span>
        <span class="n">await</span> <span class="n">session</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="o">...</span></pre></div><div class="step step-level-1" step="30" data-scale="0.16666666666666666" data-x="-666" data-y="250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="don-t-use-blocking-i-o">Don't use blocking I/O!</h1><ul><li>No socket.*</li><li>No select.*</li><li>No subprocess.*</li><li>No os.waitpid</li><li>No threading.*</li><li>No multiprocessing.*</li><li>No time.sleep</li></ul><p><em>Use async replacements!</em></p></div><div class="step step-level-1" step="31" data-scale="0.16666666666666666" data-x="-399" data-y="250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="split-up-all-long-loops">Split up all long loops!</h1><h2 id="or-use-the-threadpool-etc"><em>Or use the threadpool etc</em></h2></div><div class="step step-level-1" step="32" data-scale="0.16666666666666666" data-x="-133" data-y="250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="too-confusing">Too confusing?</h1><blockquote><p><em>"Man that thing is complex and it keeps getting more complex.
I do not have the mental capacity to casually work with asyncio."</em></p><blockquote><p>-- Armin Ronacher</p></blockquote></blockquote><p><a href="http://lucumr.pocoo.org/2016/10/30/i-dont-understand-asyncio/">http://lucumr.pocoo.org/2016/10/30/i-dont-understand-asyncio/</a></p><blockquote><p>Why is he mixing multi-threading with asyncio?</p></blockquote></div><div class="step step-level-1" step="33" data-scale="0.16666666666666666" data-x="133" data-y="250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="callback-soup-considered-harmful">Callback soup considered harmful</h1><blockquote><p><em>Your async/await functions are dumplings of local structure
floating on top of callback soup, and this has far-reaching
implications for the simplicity and correctness of your code.</em></p><blockquote><p>-- Nathaniel J. Smith</p></blockquote></blockquote><p><a href="https://vorpus.org/blog/some-thoughts-on-asynchronous-api-design-in-a-post-asyncawait-world/">https://vorpus.org/blog/some-thoughts-on-asynchronous-api-design-in-a-post-asyncawait-world/</a></p></div><div class="step step-level-1" step="34" data-scale="0.16666666666666666" data-x="399" data-y="250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="minimal-knowledge">Minimal knowledge...</h1><ul><li>asyncio.get_event_loop()</li><li>loop.create_task()</li><li>loop.run_until_complete()</li><li>loop.run_forever()</li><li>asyncio.gather()</li><li>loop.run_in_executor()</li><li>loop.close()</li></ul></div><div class="step step-level-1" step="35" data-scale="0.013888888888888888" data-x="399" data-y="215" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="asyncio-get-event-loop">asyncio.get_event_loop()</h1><p><em>You know this by now...</em></p></div><div class="step step-level-1" step="36" data-scale="0.013888888888888888" data-x="399" data-y="229" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="loop-create-task-coroutine">loop.create_task(coroutine)</h1><p>Schedule the execution of a coroutine object.</p><p>Wrap it in a task object and return that task.</p></div><div class="step step-level-1" step="37" data-scale="0.013888888888888888" data-x="399" data-y="243" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="loop-run-until-complete-coroutine">loop.run_until_complete(coroutine)</h1><p>Pass in a coroutine or a future(task).</p></div><div class="step step-level-1" step="38" data-scale="0.013888888888888888" data-x="399" data-y="256" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="loop-run-forever">loop.run_forever()</h1><p>After you created tasks...</p></div><div class="step step-level-1" step="39" data-scale="0.013888888888888888" data-x="399" data-y="270" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="asyncio-gather-coroutines-or-futures">asyncio.gather(coroutines_or_futures, ...)</h1><p>Return a future aggregating results from the given coroutine objects or futures.</p><pre class="highlight code python"><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="n">async</span> <span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Task </span><span class="si">%s</span><span class="s2">: Compute factorial(</span><span class="si">%s</span><span class="s2">)..."</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">*=</span> <span class="n">i</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Task </span><span class="si">%s</span><span class="s2">: factorial(</span><span class="si">%s</span><span class="s2">) = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
    <span class="n">factorial</span><span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">factorial</span><span class="p">(</span><span class="s2">"B"</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">factorial</span><span class="p">(</span><span class="s2">"C"</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div><div class="step step-level-1" step="40" data-scale="0.013888888888888888" data-x="399" data-y="284" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="loop-run-in-executor-executor-function-args">loop.run_in_executor(executor, function, args, ...)</h1><p>Call a function in an Executor (pool of threads or pool of processes). By default, an event loop uses a thread pool executor (ThreadPoolExecutor).</p><p>Returns a coroutine.</p></div><div class="step step-level-1" step="41" data-scale="0.16666666666666666" data-x="666" data-y="250" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="some-code-examples">Some code examples...</h1><ul><li>Watchdog</li><li>Parallel fetch</li><li><a href="https://github.com/magnus-lycka/mail2alert">https://github.com/magnus-lycka/mail2alert</a></li></ul></div><div class="step step-level-1" step="42" data-scale="0.16666666666666666" data-x="-666" data-y="416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="some-networking-libraries">Some networking libraries</h1><ul><li><a href="https://github.com/aio-libs/aiohttp">https://github.com/aio-libs/aiohttp</a></li><li><a href="https://github.com/aio-libs/aiosmtpd">https://github.com/aio-libs/aiosmtpd</a></li><li><a href="https://github.com/channelcat/sanic">https://github.com/channelcat/sanic</a></li><li><a href="https://github.com/aio-libs/aiozmq">https://github.com/aio-libs/aiozmq</a></li><li><a href="https://github.com/Polyconseil/aioamqp">https://github.com/Polyconseil/aioamqp</a></li><li><a href="https://github.com/aio-libs/aiokafka">https://github.com/aio-libs/aiokafka</a></li></ul></div><div class="step step-level-1" step="43" data-scale="0.16666666666666666" data-x="-399" data-y="416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="not-only-networking">Not only networking...</h1><ul><li><a href="https://github.com/magicstack/asyncpg">https://github.com/magicstack/asyncpg</a></li><li><a href="https://github.com/aio-libs/aiomysql">https://github.com/aio-libs/aiomysql</a></li><li><a href="https://github.com/mongodb/motor">https://github.com/mongodb/motor</a></li><li><a href="https://github.com/elastic/elasticsearch-py-async">https://github.com/elastic/elasticsearch-py-async</a></li><li><a href="https://github.com/aio-libs/aioredis">https://github.com/aio-libs/aioredis</a></li><li><a href="https://github.com/aio-libs/aiomcache">https://github.com/aio-libs/aiomcache</a></li><li><a href="https://github.com/Tinche/aiofiles/">https://github.com/Tinche/aiofiles/</a></li><li><a href="https://github.com/aio-libs/aiobotocore">https://github.com/aio-libs/aiobotocore</a></li><li><a href="https://github.com/aio-libs/aiodocker">https://github.com/aio-libs/aiodocker</a></li></ul></div><div class="step step-level-1" step="44" data-scale="0.16666666666666666" data-x="-133" data-y="416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="testing-with-asyncio">Testing with asyncio</h1><ul><li><a href="https://blog.miguelgrinberg.com/post/unit-testing-asyncio-code">https://blog.miguelgrinberg.com/post/unit-testing-asyncio-code</a></li><li><a href="https://asynctest.readthedocs.io/en/latest/">https://asynctest.readthedocs.io/en/latest/</a></li><li><a href="https://github.com/pytest-dev/pytest-asyncio">https://github.com/pytest-dev/pytest-asyncio</a></li><li><a href="http://aiohttp.readthedocs.io/en/stable/testing.html">http://aiohttp.readthedocs.io/en/stable/testing.html</a></li><li><a href="https://github.com/magnus-lycka/mail2alert/tree/master/src/test">https://github.com/magnus-lycka/mail2alert/tree/master/src/test</a></li></ul></div><div class="step step-level-1" step="45" data-scale="0.16666666666666666" data-x="133" data-y="416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="debugging-with-asyncio">Debugging with asyncio</h1><pre class="highlight code python"><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">'asyncio'</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="c1"># Enable debugging</span>
    <span class="n">event_loop</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Make the threshold for "slow" tasks very very small for</span>
    <span class="c1"># illustration. The default is 0.1, or 100 milliseconds.</span>
    <span class="n">event_loop</span><span class="o">.</span><span class="n">slow_callback_duration</span> <span class="o">=</span> <span class="mf">0.001</span>

    <span class="c1"># Report all mistakes managing asynchronous resources.</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">'always'</span><span class="p">,</span> <span class="n">ResourceWarning</span><span class="p">)</span></pre><p>...</p><pre class="highlight code bash">$ <span class="nb">export</span> <span class="nv">PYTHONASYNCIODEBUG</span><span class="o">=</span><span class="m">1</span></pre><ul><li><a href="https://pymotw.com/3/asyncio/debugging.html">https://pymotw.com/3/asyncio/debugging.html</a></li><li><a href="https://github.com/aio-libs/aiomonitor">https://github.com/aio-libs/aiomonitor</a></li></ul></div><div class="step step-level-1" step="46" data-scale="0.16666666666666666" data-x="399" data-y="416" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="references">References</h1><ul><li><a href="https://docs.python.org/3/library/asyncio.html">https://docs.python.org/3/library/asyncio.html</a></li><li><a href="https://github.com/aio-libs">https://github.com/aio-libs</a></li><li><a href="https://github.com/magnus-lycka/mail2alert">https://github.com/magnus-lycka/mail2alert</a></li><li><a href="https://github.com/magnus-lycka/gothpy-asyncio">https://github.com/magnus-lycka/gothpy-asyncio</a></li><li><a href="https://github.com/MagicStack/uvloop">https://github.com/MagicStack/uvloop</a></li><li><a href="http://lucumr.pocoo.org/2016/10/30/i-dont-understand-asyncio/">http://lucumr.pocoo.org/2016/10/30/i-dont-understand-asyncio/</a></li><li><a href="https://pymotw.com/3/asyncio/">https://pymotw.com/3/asyncio/</a></li><li><a href="https://github.com/timofurrer/awesome-asyncio">https://github.com/timofurrer/awesome-asyncio</a></li><li><a href="https://www.youtube.com/watch?v=2ZFFv-wZ8_g">https://www.youtube.com/watch?v=2ZFFv-wZ8_g</a></li></ul></div></div><div id="hovercraft-help" class="hide"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>